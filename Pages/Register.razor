@page "/register"
@layout LoginLayout
@using BlazorApp1.Models
@using Microsoft.AspNetCore.Components.Authorization
@inject Servicios.ServiciosAutenticacion serviciosAutenticacion
@inject Servicios.ServiciosUsuario serviciosUsuario
@inject Servicios.AuthStateProvider authStateProvider
@inject NavigationManager navigationManager
@inject AuthenticationStateProvider authenticationStateProvider

<div class="login-container">
    <div class="login-card register-card">
        <div class="login-header">
            <div class="login-icon">
                <i class="bi bi-person-plus-fill"></i>
            </div>
            <h3>Crear Cuenta</h3>
            <p class="text-muted">Completa el formulario para registrarte</p>
        </div>

        <div class="login-body">
            @if (!string.IsNullOrEmpty(mensajeError))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    @mensajeError
                    <button type="button" class="btn-close" @onclick="() => mensajeError = string.Empty"></button>
                </div>
            }

            @if (!string.IsNullOrEmpty(mensajeExito))
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    @mensajeExito
                    <button type="button" class="btn-close" @onclick="() => mensajeExito = string.Empty"></button>
                </div>
            }

            <div class="mb-3">
                <label class="form-label">Correo Electrónico *</label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-envelope"></i>
                    </span>
                    <input type="email"
                           class="form-control"
                           placeholder="correo@ejemplo.com"
                           @bind="nuevoUsuario.Email"
                           disabled="@cargando" />
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Contraseña *</label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-lock"></i>
                    </span>
                    <input type="@(mostrarPassword ? "text" : "password")"
                           class="form-control"
                           placeholder="Mínimo 6 caracteres"
                           @bind="nuevoUsuario.Contrasena"
                           disabled="@cargando" />
                    <button class="btn btn-outline-secondary"
                            type="button"
                            @onclick="TogglePassword"
                            disabled="@cargando">
                        <i class="bi @(mostrarPassword ? "bi-eye-slash" : "bi-eye")"></i>
                    </button>
                </div>
                @if (!string.IsNullOrEmpty(nuevoUsuario.Contrasena))
                {
                    <small class="@(ObtenerClaseFortaleza())">
                        @ObtenerTextoFortaleza()
                    </small>
                }
            </div>

            <div class="mb-3">
                <label class="form-label">Confirmar Contraseña *</label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-lock-fill"></i>
                    </span>
                    <input type="@(mostrarConfirmPassword ? "text" : "password")"
                           class="form-control"
                           placeholder="Repite tu contraseña"
                           @bind="confirmarContrasena"
                           disabled="@cargando" />
                    <button class="btn btn-outline-secondary"
                            type="button"
                            @onclick="ToggleConfirmPassword"
                            disabled="@cargando">
                        <i class="bi @(mostrarConfirmPassword ? "bi-eye-slash" : "bi-eye")"></i>
                    </button>
                </div>
            </div>

            <div class="mb-3 form-check">
                <input type="checkbox"
                       class="form-check-input"
                       id="aceptarTerminos"
                       @bind="aceptarTerminos"
                       disabled="@cargando" />
                <label class="form-check-label" for="aceptarTerminos">
                    Acepto los <a href="/terminos" target="_blank">términos y condiciones</a>
                </label>
            </div>

            <button class="btn btn-primary w-100 btn-login mb-3"
                    @onclick="RegistrarUsuario"
                    disabled="@cargando">
                @if (cargando)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <span>Registrando...</span>
                }
                else
                {
                    <i class="bi bi-person-plus me-2"></i>
                    <span>Crear Cuenta</span>
                }
            </button>

            <div class="text-center">
                <span class="text-muted">¿Ya tienes una cuenta? </span>
                <a href="/login" class="fw-bold">Iniciar Sesión</a>
            </div>
        </div>
    </div>
</div>



@code {
    private CUUsuario nuevoUsuario = new CUUsuario();
    private string confirmarContrasena = string.Empty;
    private string mensajeError = string.Empty;
    private string mensajeExito = string.Empty;
    private bool cargando = false;
    private bool mostrarPassword = false;
    private bool mostrarConfirmPassword = false;
    private bool aceptarTerminos = false;

    protected override async Task OnInitializedAsync()
    {
        // Verificar si ya está autenticado
        var authState = await authenticationStateProvider.GetAuthenticationStateAsync();
        if (authState?.User?.Identity?.IsAuthenticated == true)
        {
            navigationManager.NavigateTo("/", replace: true);
        }
    }

    private async Task RegistrarUsuario()
    {
        mensajeError = string.Empty;
        mensajeExito = string.Empty;

        // Validaciones
        if (!ValidarFormulario())
        {
            return;
        }

        cargando = true;

        try
        {
            // Activar el usuario por defecto
            nuevoUsuario.Activo = true;

            // Llamar al servicio de usuario para crear el registro
            var respuesta = await serviciosUsuario.PostUsuario(nuevoUsuario);

            if (respuesta != null && respuesta.Estado == 200)
            {
                mensajeExito = "¡Cuenta creada exitosamente! Redirigiendo al login...";

                // Esperar un momento para que el usuario vea el mensaje
                await Task.Delay(2000);

                // Redirigir al login
                navigationManager.NavigateTo("/login", replace: true);
            }
            else
            {
                mensajeError = respuesta?.Mensaje ?? "Error al crear la cuenta. Por favor intenta de nuevo.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error en RegistrarUsuario: {ex.Message}");
            mensajeError = "Error de conexión. Por favor intenta de nuevo.";
        }
        finally
        {
            cargando = false;
        }
    }

    private bool ValidarFormulario()
    {
        if (string.IsNullOrWhiteSpace(nuevoUsuario.Email))
        {
            mensajeError = "Por favor ingresa tu correo electrónico";
            return false;
        }

        if (!EsEmailValido(nuevoUsuario.Email))
        {
            mensajeError = "Por favor ingresa un correo electrónico válido";
            return false;
        }

        if (string.IsNullOrWhiteSpace(nuevoUsuario.Contrasena))
        {
            mensajeError = "Por favor ingresa una contraseña";
            return false;
        }

        if (nuevoUsuario.Contrasena.Length < 6)
        {
            mensajeError = "La contraseña debe tener al menos 6 caracteres";
            return false;
        }

        if (nuevoUsuario.Contrasena != confirmarContrasena)
        {
            mensajeError = "Las contraseñas no coinciden";
            return false;
        }

        if (!aceptarTerminos)
        {
            mensajeError = "Debes aceptar los términos y condiciones";
            return false;
        }

        return true;
    }

    private bool EsEmailValido(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private void TogglePassword()
    {
        mostrarPassword = !mostrarPassword;
    }

    private void ToggleConfirmPassword()
    {
        mostrarConfirmPassword = !mostrarConfirmPassword;
    }

    private string ObtenerClaseFortaleza()
    {
        var fortaleza = CalcularFortalezaContrasena();
        return fortaleza switch
        {
            1 => "text-weak",
            2 => "text-medium",
            3 => "text-strong",
            _ => ""
        };
    }

    private string ObtenerTextoFortaleza()
    {
        var fortaleza = CalcularFortalezaContrasena();
        return fortaleza switch
        {
            1 => "Contraseña débil",
            2 => "Contraseña media",
            3 => "Contraseña fuerte",
            _ => ""
        };
    }

    private int CalcularFortalezaContrasena()
    {
        if (string.IsNullOrEmpty(nuevoUsuario.Contrasena))
            return 0;

        int puntos = 0;

        if (nuevoUsuario.Contrasena.Length >= 8)
            puntos++;

        if (nuevoUsuario.Contrasena.Any(char.IsUpper))
            puntos++;

        if (nuevoUsuario.Contrasena.Any(char.IsDigit))
            puntos++;

        if (nuevoUsuario.Contrasena.Any(c => !char.IsLetterOrDigit(c)))
            puntos++;

        return puntos switch
        {
            0 or 1 => 1,
            2 or 3 => 2,
            _ => 3
        };
    }
}
